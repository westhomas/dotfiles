#!/bin/bash

set -x
set -euo pipefail

# Install Homebrew if not available
if ! command -v brew >/dev/null; then
  echo "Installing Homebrew..."
  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

  # Add brew to PATH for this session
  if [[ -f /opt/homebrew/bin/brew ]]; then
    eval "$(/opt/homebrew/bin/brew shellenv)"
  elif [[ -f /usr/local/bin/brew ]]; then
    eval "$(/usr/local/bin/brew shellenv)"
  elif [[ -f /home/linuxbrew/.linuxbrew/bin/brew ]]; then
    eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
  fi
fi

# Install or run chezmoi
if command -v chezmoi >/dev/null; then
  chezmoi init --apply --source $PWD
elif command -v mise >/dev/null; then
  mise exec chezmoi -- chezmoi init --apply --source $PWD
else
  sh -c "$(curl -fsLS get.chezmoi.io)" -- init --apply --source $PWD
fi

# Brew bundle if available
if command -v brew >/dev/null && [[ -f "$HOME/.Brewfile" ]]; then
  echo "Installing Homebrew packages..."
  brew bundle --file="$HOME/.Brewfile"
fi

# Install oh-my-zsh if not present (after zsh is installed via brew/mise)
if [[ ! -d "$HOME/.oh-my-zsh" ]]; then
  echo "Installing oh-my-zsh..."
  sh -c "$(curl -fsSL https://install.ohmyz.sh)" "" --unattended
fi

# Install powerlevel10k theme for oh-my-zsh
if [[ ! -d "${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}/themes/powerlevel10k" ]]; then
  echo "Installing powerlevel10k theme..."
  git clone --depth=1 https://github.com/romkatv/powerlevel10k.git "${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}/themes/powerlevel10k"
fi

exit 0
